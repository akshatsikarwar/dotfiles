#!/usr/bin/env bash
export HOSTNAME=$(hostname)
tunables=()
while [[ $# -gt 0 ]] ; do
	key="$1"
	case $key in
	-d) debug="yes"
	;;
	-s) start="yes"
	;;
	-i) init="yes"
	;;
	-v) valgrind="yes"
	;;
	-n) name="$2"
	shift
	;;
	-x) set -x
	;;
	--tunable) tunables+=(--tunable "$2")
	shift
	;;
	*) pfx="$1"
	;;
	esac
	shift
done

name=${name:-akdb}

if [[ $(uname) == "Darwin" ]]; then
    GDB="lldb --one-line run --"
else
    GDB="gdb -q -ex run --arg"
fi

if [[ $pfx == "bb" ]]; then
	comdb2="/opt/bb/bin/comdb2"
else
	pfx="$(go --print $pfx)"
	[[ -d $pfx/ninja ]] && pfx=$pfx/ninja
	[[ -d $pfx/build ]] && pfx=$pfx/build
	comdb2="${pfx}/db/comdb2"
fi

[[ ! -x ${comdb2} ]] && echo 'comdb2 binary?' && exit 1

if [[ -n $init ]] ; then
	dir=/opt/bb/var/cdb2/$name
	[[ -d $dir ]] && rm -rf $dir
	mkdir -p $dir
	tunables+=(--tunable "allow_lua_print")
	tunables+=(--tunable "dtastripe 1")
	tunables+=(--tunable "nowatch")
	#tunables+=(--tunable "setattr directio 0")
	#tunables+=(--tunable "crypto $HOME/.local/db/comdb2/passwd")
	#tunables+=(--tunable "enable_snapshot_isolation")
	#tunables+=(--tunable "enable_sql_stmt_caching all")
	#tunables+=(--tunable "logmsg level debug")
	#tunables+=(--tunable "perfect_ckp 0")

	if [[ -n $debug ]] ; then
		$GDB $comdb2 "${tunables[@]}" --create $name
	else
		echo $comdb2 "${tunables[@]}" --create $name
		$comdb2 "${tunables[@]}" --create $name
	fi
	[[ $? -ne 0 ]] && figlet bad init && exit 1
fi

if [[ -n $valgrind ]] ; then
	echo valgrind --leak-check=full $comdb2 $name
	exec valgrind --leak-check=full $comdb2 $name
elif [[ -n $debug ]] ; then
	echo $GDB $comdb2 $name
	exec $GDB $comdb2 $name
elif [[ -n $start ]] ; then
	echo $GDB $comdb2 $name
	exec $GDB -q -ex start --arg $comdb2 $name
else
	echo $comdb2 "${tunables[@]}" $name
	exec $comdb2 "${tunables[@]}" $name
fi
