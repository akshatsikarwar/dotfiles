#!/bin/bash
export HOSTNAME=$(hostname)
name='akdb'
pfx=$HOME/src/comdb2
while [[ $# -gt 0 ]] ; do
	key="$1"
	case $key in
	-d) debug="yes"
	;;
	-s) start="yes"
	;;
	-i) init="yes"
	;;
	-v) valgrind="yes"
	;;
	-n) name="$2"
	shift
	;;
	*) pfx="$1"
	;;
	esac
	shift
done

dir=$HOME/work/db/$name
lrl=$dir/$name.lrl
[[ -n $pfx ]] && pfx="$(go -p $pfx)/"
comdb2="${pfx}comdb2"

[[ ! -x ${comdb2} ]] && echo 'comdb2 binary?' && exit 1

if [[ -n $init ]] ; then
	[[ -d $dir ]] && rm -rf $dir
    mkdir -p $dir
    echo "name $name" >> $lrl
    echo "dir $dir" >> $lrl
    echo "nowatch" >> $lrl
    echo "cache 256 mb" >> $lrl
    echo "allow_lua_print" >> $lrl
    #echo "crypto $HOME/work/db/passwd" >> $lrl
    #echo "enable_sql_stmt_caching all" >> $lrl
    echo "dtastripe 1" >> $lrl
    #echo "enable_snapshot_isolation" >> $lrl
    #echo "logmsg level debug" >> $lrl
    $comdb2 $name --dir $dir --lrl $lrl --create
    [[ $? -ne 0 ]] && figlet bad init && exit 1
fi

if [[ -n $valgrind ]] ; then
	echo valgrind $comdb2 $name -lrl $lrl
	exec valgrind $comdb2 $name -lrl $lrl
elif [[ -n $debug ]] ; then
	echo gdb -q -ex run --arg $comdb2 $name -lrl $lrl
	exec gdb -q -ex run --arg $comdb2 $name -lrl $lrl
elif [[ -n $start ]] ; then
	echo gdb -q -ex start --arg $comdb2 $name -lrl $lrl
	exec gdb -q -ex start --arg $comdb2 $name -lrl $lrl
else
    echo $comdb2 $name -lrl $lrl 
	$comdb2 $name --lrl $lrl
fi
