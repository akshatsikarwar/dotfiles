#!/bin/bash

ROOT=$HOME/containers
SRC=$HOME/src/comdb2

function usage {
cat >&2 <<EOF
Usage: container [OPTION] COMMAND [NAME..]

OPTION:
  --all         Apply start/stop/delete/trust to all containers under $ROOT

COMMAND:
  bootstrap     Setup template dir with pacstrap
  create <name> Create container in btrfs subvolume
  delete <name> Delete container and btrfs subvolume
  list          List running containers
  root <name>   Get root shell in named container
  start <name>  Start named container
  stop <name>   Stop named container
  trust <name> <other..>    Add name to others' authorized_keys
EOF
exit 1
}

[[ $1 == "--all" ]] && all=1 && shift

CMD=$1
[[ -z $CMD ]] && usage
shift

if [[ -z $all ]]; then
    NAME=( $* )
else
    NAME=()
    allnames=( $(find $ROOT -type d -maxdepth 1 2>/dev/null) )
    for name in ${allnames[@]}; do
        [[ $name == $ROOT ]] && continue
        [[ $(basename $name) == "template" ]] && continue
        NAME+=($(basename $name))
    done
fi

[[ -z $NAME ]] && [[ $CMD != bootstrap ]] && [[ $CMD != list ]] && usage
shift

USER=comdb2
STARTCMD="-q --boot --network-bridge=br0"
CREATECMD="$STARTCMD --template=$ROOT/template"

function start {
    for name in ${NAME[@]}; do
        sudo systemd-nspawn $STARTCMD --bind=$SRC:/home/$USER/comdb2 --directory $ROOT/$name >/dev/null 2>&1 &
    done
}

function root {
    sudo machinectl -q shell $NAME
}

function list {
    sudo machinectl list
}

function stop {
    for name in ${NAME[@]}; do
        sudo machinectl -q poweroff $name
    done
}

function setup {
name=$1
HOST_PUBLIC_KEY=$(<$HOME/.ssh/id_rsa_thinkpad.pub)

read -d '' BASHRC <<'EOF'
PATH=/opt/bb/bin:\\\$PATH
alias installcomdb2=\\\"tar -C /opt/bb --strip-components=3 -x -f comdb2.tar.gz\\\"
EOF

read -d '' STRICT_CHECK <<'EOF'
Host \*
    StrictHostKeyChecking no
EOF

read -d '' INPUTRC <<'EOF'
set editing-mode vi

set keymap vi-command
Control-l: clear-screen

set keymap vi-insert
Control-l: clear-screen
EOF

read -d '' GDBINIT <<'EOF'
set print thread-events off
set height 0
set print pretty on
set confirm off

define whereall
thread apply all where
end

document whereall
Alias for \\\"thread apply all where\\\"
end
EOF

sudo systemd-run --pipe --machine=$name /bin/bash > /dev/null <<EOF
/usr/bin/systemctl enable systemd-networkd
/usr/bin/systemctl enable systemd-resolved
/usr/bin/systemctl enable sshd.socket
/usr/bin/hostnamectl set-hostname $name
/usr/bin/useradd $USER --create-home --user-group
/usr/bin/mkdir -p /opt/bb
/usr/bin/chown $USER:$USER /opt/bb
/usr/bin/su -c 'ssh-keygen -q -f /home/$USER/.ssh/id_rsa -N ""' $USER
/usr/bin/su -c 'echo "$HOST_PUBLIC_KEY" > /home/$USER/.ssh/authorized_keys' $USER
/usr/bin/su -c 'echo "$STRICT_CHECK" > /home/$USER/.ssh/config' $USER
/usr/bin/su -c 'echo "$BASHRC" >> /home/$USER/.bashrc' $USER
/usr/bin/su -c 'echo "$INPUTRC" >> /home/$USER/.inputrc' $USER
/usr/bin/su -c 'echo "$GDBINIT" >> /home/$USER/.gdbinit' $USER
EOF
}

function create {
    for name in ${NAME[@]}; do
        tmux split-window -p 50 -h sudo systemd-nspawn $CREATECMD --directory $ROOT/$name
        tmux select-pane -t 0
        echo -n "Press a key to run setup"
        read
        setup $name
        sudo machinectl -q poweroff $name
        sleep 1
    done
}

function delete {
    for name in ${NAME[@]}; do
        sudo btrfs subvolume delete $ROOT/$name
    done
}

function bridge {
    if ! brctl show br0 > /dev/null 2>&1; then
        sudo brctl addbr br0
    fi
    if ! ip link show br0 | grep UP > /dev/null ; then
        sudo ip link set up br0
    fi
}

function bootstrap {
    sudo pacstrap -i -c $ROOT/template base gdb make openssh protobuf-c vim
}

function make_trust {
    ssh $1 cat .ssh/id_rsa.pub | ssh $2 tee --append .ssh/authorized_keys > /dev/null
}

function trust {
    if [[ -z $all ]]; then
        for M in $*; do
            [[ $M == $NAME ]] && continue
            make_trust $NAME $M
        done
    else
        for name in ${NAME[@]}; do
            for M in ${NAME[@]}; do
                [[ $M == $name ]] && continue
                make_trust $name $M
            done
        done
    fi
}

case $CMD in
    bootstrap) bootstrap ; exit ;;
    create) bridge; create ; exit ;;
    delete) delete ; exit ;;
    list) list ; exit ;;
    root) root ; exit ;;
    start) bridge; start ; exit ;;
    stop) stop ; exit ;;
    trust) trust $* ; exit ;;
    *) usage ;;
esac
